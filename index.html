<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burnmouth - Geospatial tool kit</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Proj4js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js"></script>
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- noUiSlider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <style>
        #map { height: calc(100vh - 450px); width: 100%; border-radius: 12px; z-index: 1; transition: height 0.3s ease-in-out; }
        #map.map-expanded { height: 90vh !important; }
        .noUi-connect { background: #2563eb; }
        .date-label {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #2563eb;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 600;
            color: #1e40af;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .user-label {
            background: #1e293b;
            border: 1px solid #ffffff;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 700;
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .custom-slider .noUi-handle { border-radius: 50%; cursor: pointer; }
        input[type=range] { accent-color: #2563eb; }
        .detection-card:hover { border-color: #2563eb; background-color: #f8fafc; }
        #entityModal, #userMarkerModal { z-index: 9999; }
        .placement-cursor { cursor: crosshair !important; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 flex flex-col min-h-screen">

    <!-- Entity Assignment Modal -->
    <div id="entityModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 animate-in zoom-in duration-200">
            <div class="mb-6 text-center">
                <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                </div>
                <h2 class="text-xl font-bold text-slate-800">Identify Intelligence Entity</h2>
                <p class="text-sm text-slate-500 mt-2">To enable co-location analysis, please provide a unique description for this dataset.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block tracking-wider">Entity Description</label>
                    <input type="text" id="entityNameInput" placeholder="e.g. Target Alpha, Vehicle BX67..." class="w-full border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
                </div>
                <button id="btnConfirmEntity" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95">
                    Proceed with Ingestion
                </button>
            </div>
        </div>
    </div>

    <!-- User Marker Modal -->
    <div id="userMarkerModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 animate-in zoom-in duration-200">
            <div class="mb-4 text-center">
                <h2 id="markerModalTitle" class="text-lg font-bold text-slate-800">Tag Location</h2>
                <p class="text-xs text-slate-500 mt-1">Add or edit intelligence labels for this coordinate.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block tracking-wider">Label Content</label>
                    <input type="text" id="markerLabelInput" placeholder="e.g. Suspect Sighting, Safehouse..." class="w-full border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
                </div>
                <div class="flex gap-2">
                    <button id="btnDeleteUserMarker" class="hidden flex-1 bg-rose-50 text-rose-600 hover:bg-rose-100 font-bold py-3 rounded-xl transition-all active:scale-95">Delete</button>
                    <button id="btnSaveUserMarker" class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95">Save Tag</button>
                </div>
                <button id="btnCancelUserMarker" class="w-full text-slate-400 text-xs font-bold py-2">Cancel</button>
            </div>
        </div>
    </div>

    <nav class="bg-white border-b px-6 py-4 flex flex-wrap justify-between items-center shadow-sm gap-4">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-blue-600 rounded-lg text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-slate-800">Burnmouth - Geospatial tool kit</h1>
        </div>
        <div class="flex gap-3 items-center">
            <label class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl transition-all shadow-md active:scale-95 text-sm font-semibold inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                Import CSV
                <input type="file" id="csvFile" accept=".csv" class="hidden">
            </label>
        </div>
    </nav>

    <main class="p-4 md:p-6 max-w-7xl mx-auto space-y-4 flex-grow">
        <!-- Top Controls -->
        <div id="controls" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 space-y-6 hidden animate-in fade-in duration-500">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-6 space-y-5">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Temporal Range</label>
                            <span id="range-display" class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">--</span>
                        </div>
                        <div id="date-slider" class="custom-slider mx-2"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 pt-2">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Start Time</label>
                            <input type="datetime-local" id="input-start" class="w-full text-sm border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">End Time</label>
                            <input type="datetime-local" id="input-end" class="w-full text-sm border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50">
                        </div>
                        <div class="flex items-end">
                            <button id="btnApplyFilter" class="w-full bg-slate-800 hover:bg-slate-900 text-white p-2.5 rounded-lg text-xs font-bold transition shadow-sm h-[42px]">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-6 flex flex-col gap-6 lg:border-l lg:pl-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-2">Visualisation Style</label>
                            <div class="grid grid-cols-2 gap-1.5 p-1 bg-slate-100 rounded-xl">
                                <button id="viewMarkers" class="px-2 py-1.5 text-[10px] font-bold rounded-lg transition-all bg-white text-blue-600 shadow-sm border border-slate-200">Markers</button>
                                <button id="viewClusters" class="px-2 py-1.5 text-[10px] font-bold rounded-lg transition-all text-slate-600">Clusters</button>
                                <button id="viewHeatmap" class="px-2 py-1.5 text-[10px] font-bold rounded-lg transition-all text-slate-600">Heatmap</button>
                                <button id="viewPath" class="px-2 py-1.5 text-[10px] font-bold rounded-lg transition-all text-slate-600">Path</button>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-slate-100">
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-2">Active Entities</label>
                                <div id="entityCheckboxList" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                                    <p class="text-[10px] text-slate-400 italic">No entities loaded</p>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider block">Animation Playback</label>
                            <div class="flex items-center gap-4">
                                <button id="btnPlay" class="flex-shrink-0 p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition shadow-md">
                                    <svg id="playIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                                    <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                                </button>
                                <div class="flex-grow space-y-1">
                                    <div class="flex justify-between items-center">
                                        <label class="text-[10px] font-bold text-slate-400 uppercase">Speed</label>
                                        <span id="speed-label" class="text-[10px] font-bold text-blue-600">Moderate</span>
                                    </div>
                                    <input type="range" id="playbackSpeedRange" min="0.0005" max="0.005" step="0.0001" value="0.001" class="w-full h-1.5 bg-slate-100 rounded-lg appearance-none cursor-pointer">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap items-center justify-between gap-4 border-t border-slate-100 pt-5">
                <div class="flex flex-wrap items-center gap-4">
                    <button id="toggleLabels" class="px-4 py-2 text-xs font-bold text-slate-700 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition shadow-sm">
                        Show Labels: <span class="text-blue-600">Off</span>
                    </button>
                    <button id="toggleAutoSnap" class="px-4 py-2 text-xs font-bold text-slate-700 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition shadow-sm">
                        Auto-Snap: <span class="text-blue-600">Off</span>
                    </button>
                    <button id="btnStartDrawing" class="px-4 py-2 text-xs font-bold text-slate-700 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition shadow-sm inline-flex items-center gap-2">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Tag Location
                    </button>
                    <button id="btnResetAll" class="px-4 py-2 text-xs font-bold text-rose-600 bg-rose-50 border border-rose-100 rounded-xl hover:bg-rose-100 transition">
                        Clear Filters
                    </button>
                </div>

                <div class="flex items-center gap-3">
                    <button id="btnZoomToFit" class="px-5 py-2.5 text-xs font-bold text-white bg-blue-600 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">
                        Zoom to Fit
                    </button>
                    <div id="stats" class="text-xs font-black text-slate-700 bg-slate-100 border border-slate-200 px-4 py-2.5 rounded-xl">
                        Points: 0
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div id="empty-state" class="flex flex-col items-center justify-center min-h-[60vh] text-slate-400 bg-white rounded-3xl border-2 border-dashed border-slate-200">
            <div class="p-6 bg-slate-50 rounded-full mb-6">
                <svg class="w-12 h-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
            </div>
            <h3 class="text-slate-800 font-bold mb-2">Ready to Visualise</h3>
            <p class="text-sm max-w-xs text-center px-4">Upload a CSV file with "Date", "Time", "Easting/Northing" or "Lat/Long" to begin.</p>
        </div>

        <div id="map-container" class="relative hidden">
            <!-- Expand Button Overlay -->
            <button id="btnToggleExpand" class="absolute top-4 left-14 z-[1000] bg-white border border-slate-200 p-2 rounded-lg shadow-md hover:bg-slate-50 transition-all text-slate-600 flex items-center gap-2 text-xs font-bold">
                <svg id="expandIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                <svg id="collapseIcon" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9L4 4m0 0h4m-4 0v4m11 1l5-5m0 0h-4m4 0v4m-11 11l-5-5m0 0v4m0-4h4m11 5l5-5m0 0v-4m0 4h-4"></path></svg>
                <span>Expand map</span>
            </button>
            <div id="map" class="shadow-xl border border-slate-200"></div>
        </div>

        <!-- Analysis Section -->
        <div id="analysis-section" class="hidden space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-4">Analytical Intelligence</label>
                <div class="flex flex-col gap-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                        <button id="btnMostActive" class="h-full bg-orange-500 hover:bg-orange-600 text-white p-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest transition shadow-sm min-h-[70px]">
                            Most Active Locations
                        </button>
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex flex-col justify-between gap-2">
                            <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold text-slate-600 uppercase">Hubs (km)</span>
                                <input type="number" id="transportRadius" value="5.0" step="0.5" class="w-12 text-xs border border-slate-200 rounded p-1 font-bold outline-none">
                            </div>
                            <button id="btnDetectTransport" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-1.5 rounded-lg text-[9px] font-bold uppercase transition">Airport/Seaport detection</button>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex flex-col justify-between gap-2">
                            <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold text-slate-600 uppercase">Rail (km)</span>
                                <input type="number" id="railRadius" value="2.5" step="0.1" class="w-12 text-xs border border-slate-200 rounded p-1 font-bold outline-none">
                            </div>
                            <button id="btnDetectRail" class="w-full bg-green-600 hover:bg-green-700 text-white py-1.5 rounded-lg text-[9px] font-bold uppercase transition">Detect Rail Journey</button>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex flex-col justify-between gap-2">
                            <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold text-slate-600 uppercase">Prisons (km)</span>
                                <input type="number" id="prisonRadius" value="1.0" step="0.1" class="w-12 text-xs border border-slate-200 rounded p-1 font-bold outline-none">
                            </div>
                            <button id="btnDetectPrisons" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-1.5 rounded-lg text-[9px] font-bold uppercase transition">Detect prison visits</button>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex flex-col justify-between gap-2">
                            <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold text-slate-600 uppercase">Services (km)</span>
                                <input type="number" id="serviceRadius" value="0.5" step="0.1" class="w-12 text-xs border border-slate-200 rounded p-1 font-bold outline-none">
                            </div>
                            <button id="btnDetectService" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-1.5 rounded-lg text-[9px] font-bold uppercase transition">Detect Service Station visits</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <div class="col-span-1 md:col-span-1 flex flex-col gap-2">
                            <button id="btnDetectCarJourneys" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest transition shadow-sm min-h-[50px]">
                                Detect Journeys
                            </button>
                            <button id="btnDetectCoLocation" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white p-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest transition shadow-sm min-h-[50px]">
                                Detect Co-location
                            </button>
                        </div>
                        <div class="col-span-1 md:col-span-4 flex flex-col gap-2">
                            <div class="flex items-center bg-indigo-50 px-4 py-2 rounded-xl text-[10px] text-indigo-700 font-medium h-[50px]">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Isolate sustained movements to compare against ANPR logs and confirm vehicle utilization.
                            </div>
                            <div class="flex items-center bg-cyan-50 px-4 py-2 rounded-xl text-[10px] text-cyan-700 font-medium h-[50px] gap-4">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold uppercase opacity-60">Dist (km):</span>
                                    <input type="number" id="coLocationDist" value="1.0" step="0.1" class="w-12 bg-white border border-cyan-200 rounded px-1 outline-none">
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold uppercase opacity-60">Time (min):</span>
                                    <input type="number" id="coLocationTime" value="10" step="1" class="w-12 bg-white border border-cyan-200 rounded px-1 outline-none">
                                </div>
                                <p class="opacity-80 italic">Identify when different datasets intersect in time and space.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detection Results -->
            <div id="analysis-results" class="hidden animate-in slide-in-from-bottom-4 duration-500">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="results-title" class="text-lg font-bold text-slate-800 tracking-tight">Detection Results</h2>
                        <span id="results-count" class="px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-[10px] font-black uppercase">0 Matches</span>
                    </div>
                    <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                    <div id="no-results" class="py-12 text-center text-slate-400 border border-dashed border-slate-200 rounded-xl">
                        <p class="text-sm italic">Perform a search to see analytical detections.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-auto py-6 px-6 text-center border-t border-slate-200 bg-white">
        <p class="text-[10px] text-slate-400 font-medium tracking-wide">Created by Phil Bennett 2025. All rights reserved.</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        const MAJOR_CITIES = [
            { name: "London", lat: 51.5074, lng: -0.1278 },
            { name: "Birmingham", lat: 52.4862, lng: -1.8904 },
            { name: "Manchester", lat: 53.4808, lng: -2.2426 },
            { name: "Glasgow", lat: 55.8642, lng: -4.2518 },
            { name: "Liverpool", lat: 53.4084, lng: -2.9916 },
            { name: "Newcastle", lat: 54.9783, lng: -1.6178 },
            { name: "Sheffield", lat: 53.3811, lng: -1.4701 },
            { name: "Leeds", lat: 53.8008, lng: -1.5491 },
            { name: "Bristol", lat: 51.4545, lng: -2.5879 },
            { name: "Edinburgh", lat: 55.9533, lng: -3.1883 },
            { name: "Leicester", lat: 52.6369, lng: -1.1398 },
            { name: "Coventry", lat: 52.4068, lng: -1.5197 },
            { name: "Cardiff", lat: 51.4816, lng: -3.1791 },
            { name: "Belfast", lat: 54.5973, lng: -5.9301 },
            { name: "Nottingham", lat: 52.9548, lng: -1.1581 },
            { name: "Southampton", lat: 50.9097, lng: -1.4044 },
            { name: "Hull", lat: 53.7443, lng: -0.3325 },
            { name: "Reading", lat: 51.4543, lng: -0.9781 },
            { name: "Plymouth", lat: 50.3755, lng: -4.1427 },
            { name: "Stoke-on-Trent", lat: 53.0027, lng: -2.1794 },
            { name: "Derby", lat: 52.9225, lng: -1.4761 },
            { name: "Wolverhampton", lat: 52.5862, lng: -2.1288 },
            { name: "Swansea", lat: 51.6214, lng: -3.9436 },
            { name: "Milton Keynes", lat: 52.0406, lng: -0.7594 },
            { name: "Oxford", lat: 51.7520, lng: -1.2577 },
            { name: "Cambridge", lat: 52.2053, lng: 0.1218 },
            { name: "York", lat: 53.9591, lng: -1.0812 },
            { name: "Norwich", lat: 52.6309, lng: 1.2974 },
            { name: "Brighton", lat: 50.8225, lng: -0.1372 },
            { name: "Exeter", lat: 50.7260, lng: -3.5275 },
            { name: "Inverness", lat: 57.4778, lng: -4.2247 },
            { name: "Aberdeen", lat: 57.1497, lng: -2.0943 },
            { name: "Bournemouth", lat: 50.7192, lng: -1.8808 }
        ];

        const TRANSPORT_HUBS = [
            { name: "London Heathrow (LHR)", lat: 51.4700, lng: -0.4543 },
            { name: "London Gatwick (LGW)", lat: 51.1537, lng: -0.1821 },
            { name: "Manchester Airport (MAN)", lat: 53.3588, lng: -2.2727 },
            { name: "London Stansted (STN)", lat: 51.8860, lng: 0.2389 },
            { name: "London Luton (LTN)", lat: 51.8763, lng: -0.3717 },
            { name: "Edinburgh Airport (EDI)", lat: 55.9508, lng: -3.3615 },
            { name: "Birmingham Airport (BHX)", lat: 52.4524, lng: -1.7435 },
            { name: "Glasgow Airport (GLA)", lat: 55.8645, lng: -4.4320 },
            { name: "Bristol Airport (BRS)", lat: 51.3827, lng: -2.7191 },
            { name: "Belfast International (BFS)", lat: 54.6575, lng: -6.2158 },
            { name: "Newcastle Airport (NCL)", lat: 55.0375, lng: -1.6916 },
            { name: "London City Airport (LCY)", lat: 51.5048, lng: 0.0495 },
            { name: "Liverpool John Lennon (LPL)", lat: 53.3333, lng: -2.8500 },
            { name: "Leeds Bradford (LBA)", lat: 53.8659, lng: -1.6610 },
            { name: "Aberdeen Airport (ABZ)", lat: 57.2019, lng: -2.1978 },
            { name: "Southampton Airport (SOU)", lat: 50.9503, lng: -1.3567 },
            { name: "Port of Dover", lat: 51.1272, lng: 1.3283 },
            { name: "Port of Felixstowe", lat: 51.9540, lng: 1.3110 },
            { name: "Port of Southampton", lat: 50.9025, lng: -1.4042 },
            { name: "Port of Liverpool", lat: 53.4406, lng: -3.0034 },
            { name: "Port of Hull", lat: 53.7436, lng: -0.2886 },
            { name: "Port of Portsmouth", lat: 50.8126, lng: -1.0880 },
            { name: "Port of Tyne", lat: 54.9922, lng: -1.4426 },
            { name: "Port of Belfast", lat: 54.6186, lng: -5.8972 },
            { name: "Port of Immingham", lat: 53.6288, lng: -0.1915 },
            { name: "Port of Tilbury", lat: 51.4552, lng: 0.3547 },
            { name: "Port of Grimsby", lat: 53.5828, lng: -0.0683 },
            { name: "Port of Teesport", lat: 54.6061, lng: -1.1685 }
        ];

        const RAIL_NETWORK_WAYPOINTS = [
            { name: "WCML: London Euston Approach", lat: 51.5305, lng: -0.1340 },
            { name: "WCML: Wembley Central Corridor", lat: 51.5510, lng: -0.3015 },
            { name: "WCML: Watford Junction Corridor", lat: 51.6640, lng: -0.3920 },
            { name: "WCML: Milton Keynes Corridor", lat: 52.0345, lng: -0.7745 },
            { name: "WCML: Rugby Corridor", lat: 52.3736, lng: -1.2530 },
            { name: "WCML: Stafford Corridor", lat: 52.8055, lng: -2.1155 },
            { name: "WCML: Crewe Corridor", lat: 53.0898, lng: -2.4334 },
            { name: "WCML: Warrington Corridor", lat: 53.3855, lng: -2.6025 },
            { name: "WCML: Preston Corridor", lat: 53.7554, lng: -2.7073 },
            { name: "WCML: Lancaster Corridor", lat: 54.0490, lng: -2.8080 },
            { name: "WCML: Oxenholme Corridor", lat: 54.3060, lng: -2.7190 },
            { name: "WCML: Carlisle Corridor", lat: 54.8915, lng: -2.9320 },
            { name: "WCML: Beattock Corridor", lat: 55.3040, lng: -3.4520 },
            { name: "WCML: Motherwell Corridor", lat: 55.7920, lng: -3.9890 },
            { name: "WCML: Glasgow Central Approach", lat: 55.8590, lng: -4.2580 },
            { name: "ECML: London Kings Cross Approach", lat: 51.5320, lng: -0.1235 },
            { name: "ECML: Stevenage Corridor", lat: 51.9020, lng: -0.2070 },
            { name: "ECML: Peterborough Corridor", lat: 52.5741, lng: -0.2505 },
            { name: "ECML: Grantham Corridor", lat: 52.9110, lng: -0.6445 },
            { name: "ECML: Newark Corridor", lat: 53.0815, lng: -0.8145 },
            { name: "ECML: Retford Corridor", lat: 53.3210, lng: -0.9495 },
            { name: "ECML: Doncaster Corridor", lat: 53.5222, lng: -1.1388 },
            { name: "ECML: York Corridor", lat: 53.9585, lng: -1.0931 },
            { name: "ECML: Darlington Corridor", lat: 54.5215, lng: -1.5475 },
            { name: "ECML: Durham Corridor", lat: 54.7795, lng: -1.5830 },
            { name: "ECML: Newcastle Central Approach", lat: 54.9685, lng: -1.6160 },
            { name: "ECML: Morpeth Corridor", lat: 55.1630, lng: -1.6910 },
            { name: "ECML: Alnmouth Corridor", lat: 55.3940, lng: -1.6360 },
            { name: "ECML: Berwick-upon-Tweed Corridor", lat: 55.7745, lng: -2.0125 },
            { name: "ECML: Edinburgh Waverley Approach", lat: 55.9520, lng: -3.1895 },
            { name: "GWML: London Paddington Approach", lat: 51.5175, lng: -0.1775 },
            { name: "GWML: Slough Corridor", lat: 51.5115, lng: -0.5925 },
            { name: "GWML: Reading Corridor", lat: 51.4582, lng: -0.9715 },
            { name: "GWML: Didcot Corridor", lat: 51.6110, lng: -1.2435 },
            { name: "GWML: Swindon Corridor", lat: 51.5655, lng: -1.7855 },
            { name: "GWML: Bristol Parkway Corridor", lat: 51.5140, lng: -2.5440 },
            { name: "GWML: Newport Corridor", lat: 51.5885, lng: -2.9985 },
            { name: "GWML: Cardiff Central Approach", lat: 51.4760, lng: -3.1785 },
            { name: "GWML: Bath Spa Corridor", lat: 51.3775, lng: -2.3565 },
            { name: "MML: London St Pancras Approach", lat: 51.5315, lng: -0.1265 },
            { name: "MML: Luton Corridor", lat: 51.8815, lng: -0.4155 },
            { name: "MML: Bedford Corridor", lat: 52.1325, lng: -0.4770 },
            { name: "MML: Leicester Corridor", lat: 52.6315, lng: -1.1255 },
            { name: "MML: Nottingham Corridor", lat: 52.9465, lng: -1.1470 },
            { name: "MML: Derby Corridor", lat: 52.9160, lng: -1.4635 },
            { name: "MML: Sheffield Midland Approach", lat: 53.3775, lng: -1.4630 },
            { name: "CrossCountry: Birmingham New St Approach", lat: 52.4775, lng: -1.8995 },
            { name: "CrossCountry: Cheltenham Corridor", lat: 51.8965, lng: -2.1025 },
            { name: "CrossCountry: Oxford Corridor", lat: 51.7535, lng: -1.2705 },
            { name: "CrossCountry: Banbury Corridor", lat: 52.0620, lng: -1.3295 },
            { name: "South Western: Basingstoke Corridor", lat: 51.2685, lng: -1.0885 },
            { name: "South Western: Winchester Corridor", lat: 51.0665, lng: -1.3195 },
            { name: "South Western: Southampton Approach", lat: 50.9080, lng: -1.4075 },
            { name: "Great Eastern: Colchester Corridor", lat: 51.8985, lng: 0.8935 },
            { name: "Great Eastern: Ipswich Corridor", lat: 52.0505, lng: 1.1435 },
            { name: "Great Eastern: Norwich Approach", lat: 52.6275, lng: 1.3065 }
        ];

        const PRISONS = [
            { name: "HMP Belmarsh", lat: 51.496, lng: 0.082 },
            { name: "HMP Frankland", lat: 54.805, lng: -1.568 },
            { name: "HMP Wakefield", lat: 53.682, lng: -1.512 },
            { name: "HMP Long Lartin", lat: 52.128, lng: -1.889 },
            { name: "HMP Whitemoor", lat: 52.571, lng: 0.038 },
            { name: "HMP Full Sutton", lat: 53.984, lng: -0.871 },
            { name: "HMP Woodhill", lat: 52.054, lng: -0.814 },
            { name: "HMP Manchester (Strangeways)", lat: 53.493, lng: -2.247 },
            { name: "HMP Wandsworth", lat: 51.450, lng: -0.187 },
            { name: "HMP Pentonville", lat: 51.545, lng: -0.117 },
            { name: "HMP Wormwood Scrubs", lat: 51.516, lng: -0.238 },
            { name: "HMP Brixton", lat: 51.454, lng: -0.124 },
            { name: "HMP Birmingham (Winson Green)", lat: 52.492, lng: -1.933 },
            { name: "HMP Liverpool (Walton)", lat: 53.456, lng: -2.973 },
            { name: "HMP Leeds (Armley)", lat: 53.795, lng: -1.583 },
            { name: "HMP Hull", lat: 53.754, lng: -0.301 },
            { name: "HMP Durham", lat: 54.777, lng: -1.566 },
            { name: "HMP Bristol (Horfield)", lat: 51.482, lng: -2.595 },
            { name: "HMP Cardiff", lat: 51.487, lng: -3.171 },
            { name: "HMP Swansea", lat: 51.616, lng: -3.947 },
            { name: "HMP Nottingham", lat: 52.978, lng: -1.132 },
            { name: "HMP Leicester", lat: 52.634, lng: -1.144 },
            { name: "HMP Exeter", lat: 50.728, lng: -3.525 },
            { name: "HMP Norwich", lat: 52.634, lng: 1.312 },
            { name: "HMP Chelmsford", lat: 51.741, lng: 0.485 },
            { name: "HMP Lewes", lat: 50.877, lng: 0.001 },
            { name: "HMP Winchester", lat: 51.066, lng: -1.328 },
            { name: "HMP High Down", lat: 51.325, lng: -0.228 },
            { name: "HMP Barlinnie (Glasgow)", lat: 55.867, lng: -4.184 },
            { name: "HMP Edinburgh (Saughton)", lat: 55.928, lng: -3.268 },
            { name: "HMP Grampian (Peterhead)", lat: 57.502, lng: -1.802 },
            { name: "HMP Perth", lat: 56.386, lng: -3.435 },
            { name: "HMP Low Moss", lat: 55.918, lng: -4.218 },
            { name: "HMP Addiewell", lat: 55.862, lng: -3.612 },
            { name: "HMP Shotts", lat: 55.832, lng: -3.821 }
        ];

        const SERVICE_STATIONS = [
            { name: "London Gateway (M1)", lat: 51.632, lng: -0.264 },
            { name: "Watford Gap (M1)", lat: 52.307, lng: -1.124 },
            { name: "Newport Pagnell (M1)", lat: 52.083, lng: -0.739 },
            { name: "Leicester Forest East (M1)", lat: 52.621, lng: -1.206 },
            { name: "Trowell (M1)", lat: 52.959, lng: -1.271 },
            { name: "Tibshelf (M1)", lat: 53.138, lng: -1.334 },
            { name: "Woodall (M1)", lat: 53.332, lng: -1.258 },
            { name: "Woolley Edge (M1)", lat: 53.611, lng: -1.523 },
            { name: "Corley (M6)", lat: 52.484, lng: -1.518 },
            { name: "Hilton Park (M6)", lat: 52.645, lng: -2.062 },
            { name: "Stafford North/South (M6)", lat: 52.846, lng: -2.148 },
            { name: "Keele (M6)", lat: 52.992, lng: -2.285 },
            { name: "Sandbach (M6)", lat: 53.146, lng: -2.338 },
            { name: "Knutsford (M6)", lat: 53.303, lng: -2.408 },
            { name: "Charnock Richard (M6)", lat: 53.633, lng: -2.712 },
            { name: "Lancaster (M6)", lat: 53.968, lng: -2.766 },
            { name: "Tebay (M6)", lat: 54.444, lng: -2.607 },
            { name: "South Mimms (M25)", lat: 51.693, lng: -0.221 },
            { name: "Thurrock (M25)", lat: 51.487, lng: 0.274 },
            { name: "Clacket Lane (M25)", lat: 51.272, lng: 0.016 },
            { name: "Cobham (M25)", lat: 51.325, lng: -0.422 },
            { name: "Heston (M4)", lat: 51.488, lng: -0.384 },
            { name: "Reading (M4)", lat: 51.425, lng: -0.993 },
            { name: "Membury (M4)", lat: 51.482, lng: -1.547 },
            { name: "Leigh Delamere (M4)", lat: 51.503, lng: -2.174 },
            { name: "Magor (M4)", lat: 51.574, lng: -2.822 },
            { name: "Frankley (M5)", lat: 52.417, lng: -2.008 },
            { name: "Strensham (M5)", lat: 52.052, lng: -2.128 },
            { name: "Gloucester (M5)", lat: 51.815, lng: -2.221 },
            { name: "Michaelwood (M5)", lat: 51.666, lng: -2.414 },
            { name: "Gordano (M5)", lat: 51.483, lng: -2.723 },
            { name: "Sedgemoor (M5)", lat: 51.282, lng: -2.923 },
            { name: "Taunton Deane (M5)", lat: 50.982, lng: -3.142 },
            { name: "Beaconsfield (M40)", lat: 51.602, lng: -0.662 },
            { name: "Oxford (M40)", lat: 51.745, lng: -1.096 },
            { name: "Cherwell Valley (M40)", lat: 51.942, lng: -1.212 },
            { name: "Warwick (M40)", lat: 52.203, lng: -1.503 },
            { name: "Birch (M62)", lat: 53.562, lng: -2.223 },
            { name: "Hartshead Moor (M62)", lat: 53.716, lng: -1.742 },
            { name: "Ferrybridge (M62)", lat: 53.715, lng: -1.278 },
            { name: "Baldock (A1M)", lat: 51.983, lng: -0.212 },
            { name: "Peterborough (A1M)", lat: 52.518, lng: -0.316 },
            { name: "Doncaster (A1M)", lat: 53.512, lng: -1.082 },
            { name: "Fleet (M3)", lat: 51.284, lng: -0.832 },
            { name: "Winchester (M3)", lat: 51.107, lng: -1.282 },
            { name: "Hopwood Park (M42)", lat: 52.368, lng: -1.942 },
            { name: "Donington Park (M1/A50)", lat: 52.842, lng: -1.348 }
        ];

        proj4.defs("EPSG:27700", "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs");

        let map, markerLayer, heatLayer, pathLayer, clusterLayer, userMarkerLayer;
        let allData = [];
        let userMarkers = []; // { id, lat, lng, label }
        let dateRange = { min: 0, max: 0 };
        let currentView = 'markers'; 
        let showLabels = false, autoSnap = false, isPlaying = false, playInterval = null;
        let isPlacementMode = false;
        let pendingCsvData = null; 
        let editingUserMarker = null;
        const LABEL_LIMIT = 500;
        
        let uniqueEntities = new Set();
        let entityColors = {}; 
        let activeEntityFilters = new Set();

        function getNextColor(index) {
            const palette = ["#2563eb", "#dc2626", "#16a34a", "#9333ea", "#ea580c", "#0891b2", "#4f46e5", "#be185d", "#ca8a04", "#15803d"];
            return palette[index % palette.length];
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function getAreaDescription(lat, lng) {
            let closest = null, minDist = Infinity;
            MAJOR_CITIES.forEach(city => {
                const d = getDistance(lat, lng, city.lat, city.lng);
                if (d < minDist) { minDist = d; closest = city; }
            });
            if (minDist < 1) return `Within ${closest.name} city centre`;
            if (minDist < 5) return `Approx ${minDist.toFixed(1)}km from ${closest.name}`;
            if (minDist < 15) return `Suburbs of ${closest.name}`;
            return `Region of ${closest.name}`;
        }

        function initMap() {
            if (map) return;
            const voyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap, &copy; CARTO' });
            const darkMatter = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap, &copy; CARTO' });
            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' });
            const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
            const baseMaps = { "Voyager (Light)": voyager, "Dark Matter": darkMatter, "OpenStreetMap": osm, "Satellite Imagery": satellite };
            map = L.map('map', { preferCanvas: true, layers: [voyager] }).setView([54.5, -3.0], 6);
            L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);
            L.control.scale({ imperial: true, metric: true, position: 'bottomright' }).addTo(map);

            markerLayer = L.layerGroup().addTo(map);
            pathLayer = L.layerGroup().addTo(map);
            userMarkerLayer = L.layerGroup().addTo(map);
            clusterLayer = L.markerClusterGroup({ disableClusteringAtZoom: 17, spiderfyOnMaxZoom: true }).addTo(map);

            map.on('click', (e) => {
                if (isPlacementMode) {
                    togglePlacementMode(false);
                    openUserMarkerModal(null, e.latlng.lat, e.latlng.lng);
                }
            });
        }

        function togglePlacementMode(force) {
            isPlacementMode = typeof force === 'boolean' ? force : !isPlacementMode;
            const mapEl = document.getElementById('map');
            const btn = document.getElementById('btnStartDrawing');
            if (isPlacementMode) {
                mapEl.classList.add('placement-cursor');
                btn.classList.add('ring-4', 'ring-blue-400', 'bg-slate-50');
                btn.innerText = "Click Map to Tag";
            } else {
                mapEl.classList.remove('placement-cursor');
                btn.classList.remove('ring-4', 'ring-blue-400', 'bg-slate-50');
                btn.innerHTML = `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> Tag Location`;
            }
        }

        function openUserMarkerModal(markerId, lat, lng) {
            const modal = document.getElementById('userMarkerModal');
            const input = document.getElementById('markerLabelInput');
            const delBtn = document.getElementById('btnDeleteUserMarker');
            const title = document.getElementById('markerModalTitle');
            
            modal.classList.remove('hidden');
            input.focus();
            
            if (markerId !== null) {
                const existing = userMarkers.find(m => m.id === markerId);
                editingUserMarker = { ...existing };
                input.value = existing.label;
                delBtn.classList.remove('hidden');
                title.innerText = "Edit Tag";
            } else {
                editingUserMarker = { id: Date.now(), lat, lng, label: '' };
                input.value = '';
                delBtn.classList.add('hidden');
                title.innerText = "Tag Location";
            }
        }

        function saveUserMarker() {
            const label = document.getElementById('markerLabelInput').value.trim();
            if (!label) return;
            
            editingUserMarker.label = label;
            const index = userMarkers.findIndex(m => m.id === editingUserMarker.id);
            if (index !== -1) userMarkers[index] = editingUserMarker;
            else userMarkers.push(editingUserMarker);
            
            document.getElementById('userMarkerModal').classList.add('hidden');
            updateUserMarkersOnMap();
        }

        function deleteUserMarker() {
            if (!editingUserMarker) return;
            userMarkers = userMarkers.filter(m => m.id !== editingUserMarker.id);
            document.getElementById('userMarkerModal').classList.add('hidden');
            updateUserMarkersOnMap();
        }

        function updateUserMarkersOnMap() {
            userMarkerLayer.clearLayers();
            userMarkers.forEach(m => {
                const marker = L.circleMarker([m.lat, m.lng], {
                    radius: 8,
                    fillColor: '#1e293b',
                    color: '#ffffff',
                    weight: 2,
                    fillOpacity: 1
                }).bindTooltip(m.label, {
                    permanent: true,
                    direction: 'top',
                    className: 'user-label',
                    offset: [0, -10]
                }).addTo(userMarkerLayer);
                
                marker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    openUserMarkerModal(m.id);
                });
            });
        }

        function parseUKDate(dateStr, timeStr) {
            if (!dateStr) return NaN;
            dateStr = dateStr.toString().trim();
            timeStr = (timeStr || "00:00:00").toString().trim();
            const dateParts = dateStr.split(/[\/\-.]/);
            if (dateParts.length !== 3) return new Date(dateStr + ' ' + timeStr).getTime();
            const day = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1; 
            const year = dateParts[2].length === 2 ? 2000 + parseInt(dateParts[2], 10) : parseInt(dateParts[2], 10);
            const timeParts = timeStr.split(':');
            const hour = parseInt(timeParts[0], 10) || 0;
            const min = parseInt(timeParts[1], 10) || 0;
            const sec = parseInt(timeParts[2], 10) || 0;
            return new Date(year, month, day, hour, min, sec).getTime();
        }

        function formatToLocalISO(timestamp) {
            const date = new Date(timestamp);
            const pad = (n) => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function updateEntityCheckboxes() {
            const container = document.getElementById('entityCheckboxList');
            container.innerHTML = '';
            if (uniqueEntities.size === 0) {
                container.innerHTML = '<p class="text-[10px] text-slate-400 italic">No entities loaded</p>';
                return;
            }
            uniqueEntities.forEach(entity => {
                const label = document.createElement('label');
                label.className = "inline-flex items-center gap-2 bg-slate-50 border border-slate-200 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-white transition-colors text-[10px] font-bold text-slate-700";
                const isChecked = activeEntityFilters.has(entity);
                const color = entityColors[entity] || "#2563eb";
                label.innerHTML = `<input type="checkbox" value="${entity}" ${isChecked ? 'checked' : ''} class="w-3 h-3 rounded text-blue-600 focus:ring-blue-500"><div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${color}"></div><span class="truncate max-w-[120px]">${entity}</span>`;
                label.querySelector('input').onchange = (e) => {
                    if (e.target.checked) activeEntityFilters.add(entity);
                    else activeEntityFilters.delete(entity);
                    updateMap();
                };
                container.appendChild(label);
            });
        }

        function processData(data, entityName) {
            let validDates = [];
            if (!uniqueEntities.has(entityName)) { entityColors[entityName] = getNextColor(uniqueEntities.size); }
            uniqueEntities.add(entityName);
            activeEntityFilters.add(entityName);

            data.forEach(row => {
                const easting = row.Easting ?? row.easting ?? row.EASTING;
                const northing = row.Northing ?? row.northing ?? row.NORTHING;
                const latVal = row.Lat ?? row.lat ?? row.LAT ?? row.Latitude ?? row.latitude;
                const lngVal = row.Long ?? row.long ?? row.LONG ?? row.Longitude ?? row.longitude ?? row.Lng ?? row.lng;
                const dateStr = row.Date ?? row.date ?? row.DATE;
                const timeStr = row.Time ?? row.time ?? row.TIME;

                let finalLat = null, finalLng = null;

                if (latVal !== undefined && lngVal !== undefined) {
                    finalLat = parseFloat(latVal);
                    finalLng = parseFloat(lngVal);
                } else if (easting !== undefined && northing !== undefined) {
                    try {
                        const coords = proj4("EPSG:27700", "WGS84", [parseFloat(easting), parseFloat(northing)]);
                        finalLng = coords[0];
                        finalLat = coords[1];
                    } catch (e) { }
                }

                if (finalLat !== null && finalLng !== null && !isNaN(finalLat) && !isNaN(finalLng) && dateStr) {
                    const ts = parseUKDate(dateStr, timeStr);
                    if (!isNaN(ts)) {
                        allData.push({ lat: finalLat, lng: finalLng, ts, dateObj: new Date(ts), label: `${entityName}: ${dateStr} ${timeStr || ''}`.trim(), entity: entityName });
                        validDates.push(ts);
                    }
                }
            });
            if (allData.length === 0) return;
            allData.sort((a, b) => a.ts - b.ts);
            dateRange.min = Math.min(...allData.map(d => d.ts));
            dateRange.max = Math.max(...allData.map(d => d.ts));
            updateEntityCheckboxes();
            showApp();
            initSlider();
            zoomToFit(allData);
            updateMap(false); 
        }

        function initSlider() {
            const slider = document.getElementById('date-slider');
            const rangeDisplay = document.getElementById('range-display');
            if (slider.noUiSlider) slider.noUiSlider.destroy();
            noUiSlider.create(slider, { start: [dateRange.min, dateRange.max], connect: true, behaviour: 'tap-drag', range: { 'min': dateRange.min, 'max': dateRange.max }, step: 1000 });
            slider.noUiSlider.on('update', (values) => {
                const s = parseInt(values[0]), e = parseInt(values[1]);
                document.getElementById('input-start').value = formatToLocalISO(s);
                document.getElementById('input-end').value = formatToLocalISO(e);
                rangeDisplay.innerText = `${new Date(s).toLocaleDateString('en-GB')} - ${new Date(e).toLocaleDateString('en-GB')}`;
            });
            slider.noUiSlider.on('change', () => { if (isPlaying) togglePlayback(); updateMap(); });
        }

        function togglePlayback() {
            const btn = document.getElementById('btnPlay');
            const playIcon = document.getElementById('playIcon'), pauseIcon = document.getElementById('pauseIcon'), slider = document.getElementById('date-slider');
            if (isPlaying) { clearInterval(playInterval); playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); isPlaying = false; }
            else {
                playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); isPlaying = true;
                playInterval = setInterval(() => {
                    const multiplier = parseFloat(document.getElementById('playbackSpeedRange').value), totalRange = dateRange.max - dateRange.min, step = (totalRange / 100) * multiplier; 
                    const [currStart, currEnd] = slider.noUiSlider.get().map(v => parseInt(v));
                    let nextEnd = currEnd + step;
                    if (nextEnd > dateRange.max) { slider.noUiSlider.set([currStart, dateRange.max]); togglePlayback(); return; }
                    slider.noUiSlider.set([nextEnd - (currEnd - currStart), nextEnd]);
                    updateMap(autoSnap); 
                }, 50);
            }
        }

        function updateMap(shouldCentre = false) {
            if (!map || !allData.length) return;
            const slider = document.getElementById('date-slider'), [start, end] = slider.noUiSlider.get().map(v => parseInt(v));
            const filtered = allData.filter(d => d.ts >= start && d.ts <= end && activeEntityFilters.has(d.entity));
            document.getElementById('stats').innerText = `Points: ${filtered.length.toLocaleString()}`;
            markerLayer.clearLayers(); pathLayer.clearLayers(); clusterLayer.clearLayers(); if (heatLayer) map.removeLayer(heatLayer);
            if (filtered.length > 0) {
                if (currentView === 'markers') {
                    filtered.forEach((d, idx) => {
                        const color = entityColors[d.entity] || "#2563eb", m = L.circleMarker([d.lat, d.lng], { radius: 6, fillColor: color, color: "#ffffff", weight: 2, opacity: 1, fillOpacity: 0.9 }).bindPopup(`<p class="text-xs font-bold">${d.label}</p>`);
                        if (showLabels && idx < LABEL_LIMIT) m.bindTooltip(d.label, { permanent: true, direction: 'top', className: 'date-label', offset: [0, -8] });
                        m.addTo(markerLayer);
                    });
                } else if (currentView === 'clusters') {
                    filtered.forEach((d) => {
                        const color = entityColors[d.entity] || "#2563eb", m = L.circleMarker([d.lat, d.lng], { radius: 6, fillColor: color, color: "#ffffff", weight: 2, opacity: 1, fillOpacity: 0.9 }).bindPopup(`<p class="text-xs font-bold">${d.label}</p>`);
                        clusterLayer.addLayer(m);
                    });
                } else if (currentView === 'heat') { heatLayer = L.heatLayer(filtered.map(d => [d.lat, d.lng, 0.6]), { radius: 20, blur: 15 }).addTo(map); }
                else if (currentView === 'path') {
                    activeEntityFilters.forEach(entity => {
                        const entityPoints = filtered.filter(p => p.entity === entity);
                        if (entityPoints.length > 1) {
                            const latlngs = entityPoints.map(p => [p.lat, p.lng]), color = entityColors[entity] || "#2563eb";
                            L.polyline(latlngs, { color: color, weight: 3, opacity: 0.7, dashArray: '5, 10' }).addTo(pathLayer);
                        }
                    });
                }
                if (shouldCentre) {
                    const lats = filtered.map(p => p.lat), lngs = filtered.map(p => p.lng);
                    map.panTo([lats.reduce((a, b) => a + b, 0) / lats.length, lngs.reduce((a, b) => a + b, 0) / lngs.length], { animate: true, duration: 0.5 });
                }
            }
        }

        function renderResults(results, title) {
            document.getElementById('analysis-results').classList.remove('hidden');
            document.getElementById('results-title').innerText = title;
            document.getElementById('results-count').innerText = `${results.length} Matches`;
            const grid = document.getElementById('results-grid');
            grid.innerHTML = '';
            document.getElementById('no-results').classList.toggle('hidden', results.length > 0);
            results.forEach(res => {
                const card = document.createElement('div'), areaDesc = res.areaDescription || (res.entity.lat ? getAreaDescription(res.entity.lat, res.entity.lng) : '');
                card.className = "detection-card bg-white border border-slate-100 p-4 rounded-xl shadow-sm cursor-pointer transition-all";
                card.innerHTML = `<div class="flex justify-between items-start mb-2"><h4 class="text-xs font-bold text-slate-800 uppercase tracking-tight truncate pr-2">${res.entity.name}</h4><span class="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-black flex-shrink-0">X${res.matches.length}</span></div><div class="space-y-1.5 mb-3"><p class="text-[10px] text-slate-700 font-semibold leading-relaxed">${areaDesc}</p>${res.temporalSummary ? `<p class="text-[9px] text-slate-500 font-medium bg-slate-50 p-1.5 rounded border border-slate-100">${res.temporalSummary}</p>` : ''}<p class="text-[10px] text-slate-400">Duration: ${res.duration || 'N/A'}</p></div><div class="text-[9px] text-blue-500 font-bold uppercase tracking-wider">Visualise Journey</div>`;
                card.onclick = () => {
                    markerLayer.clearLayers(); pathLayer.clearLayers();
                    const group = L.featureGroup(), latlngs = [];
                    res.matches.forEach(p => {
                        const color = entityColors[p.entity] || "#ef4444";
                        latlngs.push([p.lat, p.lng]);
                        L.circleMarker([p.lat, p.lng], { radius: 7, fillColor: color, color: '#fff', weight: 2, fillOpacity: 1 }).bindPopup(`<div class="text-[10px]"><strong>Event:</strong> ${p.label}<br><strong>Coords:</strong> ${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}</div>`).bindTooltip(p.label, { permanent: true, direction: 'top', className: 'date-label', offset: [0, -8] }).addTo(group);
                    });
                    if (latlngs.length > 1) { L.polyline(latlngs, { color: entityColors[res.matches[0].entity] || "#ef4444", weight: 4, opacity: 0.8 }).addTo(pathLayer); }
                    group.addTo(markerLayer); map.fitBounds(group.getBounds(), { padding: [50, 50], animate: true });
                    window.scrollTo({ top: document.getElementById('map-container').offsetTop - 20, behavior: 'smooth' });
                };
                grid.appendChild(card);
            });
            window.scrollTo({ top: document.getElementById('analysis-results').offsetTop - 20, behavior: 'smooth' });
        }

        function detectCarJourneys() {
            const slider = document.getElementById('date-slider'), [start, end] = slider.noUiSlider.get().map(v => parseInt(v));
            const filtered = allData.filter(d => d.ts >= start && d.ts <= end && activeEntityFilters.has(d.entity));
            if (filtered.length < 2) return;
            const MIN_DISPLACEMENT = 30, MAX_GAP = 2 * 60 * 60 * 1000, MIN_DURATION = 60 * 60 * 1000, journeys = [];
            let currentJourney = [filtered[0]];
            for (let i = 1; i < filtered.length; i++) {
                if (filtered[i].ts - filtered[i-1].ts > MAX_GAP) { processJourney(currentJourney); currentJourney = [filtered[i]]; }
                else { currentJourney.push(filtered[i]); }
            }
            processJourney(currentJourney);
            function processJourney(jPoints) {
                if (jPoints.length < 2) return;
                const duration = jPoints[jPoints.length - 1].ts - jPoints[0].ts, displacement = getDistance(jPoints[0].lat, jPoints[0].lng, jPoints[jPoints.length - 1].lat, jPoints[jPoints.length - 1].lng);
                if (duration >= MIN_DURATION && displacement >= MIN_DISPLACEMENT) {
                    let totalPath = 0; for(let k = 1; k < jPoints.length; k++) { totalPath += getDistance(jPoints[k-1].lat, jPoints[k-1].lng, jPoints[k].lat, jPoints[k].lng); }
                    if (totalPath < displacement * 4) { journeys.push([...jPoints]); }
                }
            }
            const results = journeys.map((j, idx) => {
                const durMs = j[j.length-1].ts - j[0].ts, hours = Math.floor(durMs / 3600000), mins = Math.floor((durMs % 3600000) / 60000), disp = getDistance(j[0].lat, j[0].lng, j[j.length-1].lat, j[j.length-1].lng).toFixed(1);
                return { entity: { name: `Journey #${idx+1} (${j[0].entity})`, lat: j[0].lat, lng: j[0].lng }, matches: j, duration: `${hours}h ${mins}m (${disp}km displacement)`, areaDescription: `From ${getAreaDescription(j[0].lat, j[0].lng).split('from ')[1] || 'Start'} to ${getAreaDescription(j[j.length-1].lat, j[j.length-1].lng).split('from ')[1] || 'End'}`, temporalSummary: `Started: ${j[0].label} <br> Finished: ${j[j.length-1].label}` };
            });
            renderResults(results, "High-Confidence Journeys (>30km)");
        }

        function detectMostActive() {
            const slider = document.getElementById('date-slider'), [start, end] = slider.noUiSlider.get().map(v => parseInt(v));
            const filtered = allData.filter(d => d.ts >= start && d.ts <= end && activeEntityFilters.has(d.entity)), clusters = {};
            filtered.forEach(p => { const key = `${p.lat.toFixed(3)},${p.lng.toFixed(3)}`; if (!clusters[key]) { clusters[key] = { entity: { name: `Hotspot`, lat: p.lat, lng: p.lng }, matches: [], areaDescription: getAreaDescription(p.lat, p.lng) }; } clusters[key].matches.push(p); });
            const sorted = Object.values(clusters).sort((a, b) => b.matches.length - a.matches.length).slice(0, 12);
            sorted.forEach((item, idx) => { item.entity.name = `Activity Hotspot #${idx + 1}`; });
            renderResults(sorted, "Top 12 Most Active Locations");
        }

        function detectCoLocation() {
            const maxDist = parseFloat(document.getElementById('coLocationDist').value);
            const maxTimeMs = parseFloat(document.getElementById('coLocationTime').value) * 60000;
            const slider = document.getElementById('date-slider'), [start, end] = slider.noUiSlider.get().map(v => parseInt(v));
            const filtered = allData.filter(d => d.ts >= start && d.ts <= end && activeEntityFilters.has(d.entity));
            
            if (uniqueEntities.size < 2) return;
            const entityGroups = {};
            filtered.forEach(p => { if (!entityGroups[p.entity]) entityGroups[p.entity] = []; entityGroups[p.entity].push(p); });
            
            const entityList = Object.keys(entityGroups);
            const intersections = [];
            for (let i = 0; i < entityList.length; i++) {
                for (let j = i + 1; j < entityList.length; j++) {
                    const e1 = entityGroups[entityList[i]]; const e2 = entityGroups[entityList[j]];
                    e1.forEach(p1 => {
                        e2.forEach(p2 => {
                            const timeDiff = Math.abs(p1.ts - p2.ts);
                            if (timeDiff <= maxTimeMs) {
                                const dist = getDistance(p1.lat, p1.lng, p2.lat, p2.lng);
                                if (dist <= maxDist) {
                                    intersections.push({
                                        entity: { name: `Intersection: ${p1.entity} & ${p2.entity}`, lat: p1.lat, lng: p1.lng },
                                        matches: [p1, p2],
                                        areaDescription: getAreaDescription(p1.lat, p1.lng),
                                        temporalSummary: `Time gap: ${(timeDiff / 60000).toFixed(1)} mins<br>Spatial gap: ${dist.toFixed(2)} km`,
                                        duration: new Date(p1.ts).toLocaleString('en-GB')
                                    });
                                }
                            }
                        });
                    });
                }
            }
            const uniqueIntersections = intersections.filter((v, i, a) => a.findIndex(t => (t.matches[0].ts === v.matches[0].ts && t.matches[1].ts === v.matches[1].ts)) === i);
            renderResults(uniqueIntersections, "Entity Co-location Detections");
        }

        function detectEntities(list, radiusId, title) {
            const radius = parseFloat(document.getElementById(radiusId).value), slider = document.getElementById('date-slider'), [start, end] = slider.noUiSlider.get().map(v => parseInt(v));
            const filtered = allData.filter(d => d.ts >= start && d.ts <= end && activeEntityFilters.has(d.entity)), results = [];
            list.forEach(entity => { const matches = filtered.filter(p => getDistance(p.lat, p.lng, entity.lat, entity.lng) <= radius); if (matches.length > 0) results.push({ entity, matches, areaDescription: getAreaDescription(entity.lat, entity.lng) }); });
            renderResults(results, title);
        }

        function zoomToFit(data) {
            const points = data || allData, filteredPoints = points.filter(p => activeEntityFilters.has(p.entity));
            if (filteredPoints.length > 0) { map.fitBounds(L.latLngBounds(filteredPoints.map(d => [d.lat, d.lng])), { padding: [40, 40], animate: true }); }
        }

        function showApp() {
            document.getElementById('empty-state').classList.add('hidden'); document.getElementById('controls').classList.remove('hidden'); document.getElementById('map-container').classList.remove('hidden'); document.getElementById('analysis-section').classList.remove('hidden');
            initMap(); map.invalidateSize();
        }

        document.getElementById('csvFile').onchange = e => { if (e.target.files[0]) { Papa.parse(e.target.files[0], { header: true, dynamicTyping: true, skipEmptyLines: true, complete: (r) => { pendingCsvData = r.data; document.getElementById('entityModal').classList.remove('hidden'); document.getElementById('entityNameInput').focus(); } }); } };

        document.getElementById('btnConfirmEntity').onclick = () => {
            const nameInput = document.getElementById('entityNameInput'), name = nameInput.value.trim();
            if (name && pendingCsvData) { processData(pendingCsvData, name); document.getElementById('entityModal').classList.add('hidden'); nameInput.value = ''; pendingCsvData = null; }
            else { nameInput.classList.add('border-rose-500'); setTimeout(() => nameInput.classList.remove('border-rose-500'), 1000); }
        };

        document.getElementById('btnStartDrawing').onclick = (e) => {
            L.DomEvent.stopPropagation(e);
            togglePlacementMode();
        };
        
        document.getElementById('btnSaveUserMarker').onclick = saveUserMarker;
        document.getElementById('btnDeleteUserMarker').onclick = deleteUserMarker;
        document.getElementById('btnCancelUserMarker').onclick = () => {
            document.getElementById('userMarkerModal').classList.add('hidden');
            editingUserMarker = null;
        };

        document.getElementById('btnPlay').onclick = togglePlayback;
        document.getElementById('viewMarkers').onclick = () => setView('markers', 'viewMarkers');
        document.getElementById('viewClusters').onclick = () => setView('clusters', 'viewClusters');
        document.getElementById('viewHeatmap').onclick = () => setView('heat', 'viewHeatmap');
        document.getElementById('viewPath').onclick = () => setView('path', 'viewPath');
        document.getElementById('btnDetectTransport').onclick = () => detectEntities(TRANSPORT_HUBS, 'transportRadius', 'Airports & Seaports Detections');
        document.getElementById('btnDetectRail').onclick = () => detectEntities(RAIL_NETWORK_WAYPOINTS, 'railRadius', 'Rail Corridor Journey Detections');
        document.getElementById('btnDetectPrisons').onclick = () => detectEntities(PRISONS, 'prisonRadius', 'Correctional Facility Detections');
        document.getElementById('btnDetectService').onclick = () => detectEntities(SERVICE_STATIONS, 'serviceRadius', 'Service Station Detections');
        document.getElementById('btnMostActive').onclick = detectMostActive;
        document.getElementById('btnDetectCarJourneys').onclick = detectCarJourneys;
        document.getElementById('btnDetectCoLocation').onclick = detectCoLocation;

        function setView(type, btnId) {
            currentView = type;
            ['viewMarkers', 'viewClusters', 'viewHeatmap', 'viewPath'].forEach(id => { const b = document.getElementById(id); if (b) b.className = id === btnId ? "px-2 py-1.5 text-[10px] font-bold rounded-lg transition-all bg-white text-blue-600 shadow-sm border border-slate-200" : "px-2 py-1.5 text-[10px] font-bold rounded-lg transition-all text-slate-600"; });
            updateMap();
        }

        document.getElementById('btnApplyFilter').onclick = () => { const s = new Date(document.getElementById('input-start').value).getTime(), e = new Date(document.getElementById('input-end').value).getTime(); if (!isNaN(s) && !isNaN(e)) { document.getElementById('date-slider').noUiSlider.set([s, e]); updateMap(); } };
        document.getElementById('btnZoomToFit').onclick = () => { const [s, e] = document.getElementById('date-slider').noUiSlider.get().map(v => parseInt(v)); zoomToFit(allData.filter(d => d.ts >= s && d.ts <= e)); };
        
        document.getElementById('btnResetAll').onclick = () => { 
            if (isPlaying) togglePlayback(); 
            uniqueEntities.forEach(entity => activeEntityFilters.add(entity));
            updateEntityCheckboxes();
            if (document.getElementById('date-slider').noUiSlider) {
                document.getElementById('date-slider').noUiSlider.set([dateRange.min, dateRange.max]);
            }
            document.getElementById('analysis-results').classList.add('hidden');
            document.getElementById('results-grid').innerHTML = '';
            updateMap();
            updateUserMarkersOnMap(); // Ensure user markers persist visually
            zoomToFit();
        };
        
        document.getElementById('toggleLabels').onclick = function() { showLabels = !showLabels; this.innerHTML = `Show Labels: <span class="text-blue-600">${showLabels ? 'On' : 'Off'}</span>`; updateMap(); };
        document.getElementById('toggleAutoSnap').onclick = function() { autoSnap = !autoSnap; this.innerHTML = `Auto-Snap: <span class="text-blue-600">${autoSnap ? 'On' : 'Off'}</span>`; };
        
        document.getElementById('btnToggleExpand').onclick = function() {
            const mapEl = document.getElementById('map');
            const expandIcon = document.getElementById('expandIcon');
            const collapseIcon = document.getElementById('collapseIcon');
            const btnSpan = this.querySelector('span');
            mapEl.classList.toggle('map-expanded');
            if (mapEl.classList.contains('map-expanded')) {
                expandIcon.classList.add('hidden');
                collapseIcon.classList.remove('hidden');
                btnSpan.innerText = "Normal View";
            } else {
                expandIcon.classList.remove('hidden');
                collapseIcon.classList.add('hidden');
                btnSpan.innerText = "Expand map";
            }
            setTimeout(() => { map.invalidateSize(); }, 300);
        };

        window.onload = initMap;
    </script>
</body>
</html>
