<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burnmouth - Geospatial tool kit</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <style>
        #map { height: calc(100vh - 450px); width: 100%; border-radius: 12px; z-index: 1; transition: height 0.3s ease-in-out; }
        #map.map-expanded { height: 90vh !important; }
        #view-3d { height: calc(100vh - 450px); width: 100%; border-radius: 12px; z-index: 1; background: #0f172a; position: relative; overflow: hidden; }
        #view-3d.map-expanded { height: 90vh !important; }
        .noUi-connect { background: #2563eb; }
        .date-label {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #2563eb;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 600;
            color: #1e40af;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .user-label {
            background: #1e293b;
            border: 1px solid #ffffff;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 700;
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .custom-slider .noUi-handle { border-radius: 50%; cursor: pointer; }
        input[type=range] { accent-color: #2563eb; }
        .detection-card:hover { border-color: #2563eb; background-color: #f8fafc; }
        #entityModal, #userMarkerModal { z-index: 9999; }
        .placement-cursor { cursor: crosshair !important; }
        
        /* 3D Nav Button */
        #nav-joystick {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            cursor: grab;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            transition: transform 0.1s;
        }
        #nav-joystick:active { cursor: grabbing; background: rgba(37, 99, 235, 0.4); border-color: #3b82f6; transform: scale(0.95); }
        #nav-joystick::after {
            content: '';
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        
        /* Duplicate Top Joystick */
        #nav-joystick-top {
            position: absolute;
            top: 60px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            cursor: grab;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            transition: transform 0.1s;
        }
        #nav-joystick-top:active { cursor: grabbing; background: rgba(37, 99, 235, 0.4); border-color: #3b82f6; transform: scale(0.95); }
        #nav-joystick-top::after {
            content: '';
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        /* New Selection Box Style */
        .selection-box {
            position: absolute;
            border: 2px dashed #3b82f6;
            background-color: rgba(59, 130, 246, 0.2);
            pointer-events: none;
            z-index: 20;
            display: none;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 flex flex-col min-h-screen">

    <div id="entityModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 animate-in zoom-in duration-200">
            <div class="mb-6 text-center">
                <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                </div>
                <h2 class="text-xl font-bold text-slate-800">Identify Intelligence Entity</h2>
                <p class="text-sm text-slate-500 mt-2">To enable co-location analysis, please provide a unique description for this dataset.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block tracking-wider">Entity Description</label>
                    <input type="text" id="entityNameInput" placeholder="e.g. Target Alpha, Vehicle BX67..." class="w-full border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
                </div>
                <button id="btnConfirmEntity" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95">
                    Proceed with Ingestion
                </button>
            </div>
        </div>
    </div>

    <div id="userMarkerModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 animate-in zoom-in duration-200">
            <div class="mb-4 text-center">
                <h2 id="markerModalTitle" class="text-lg font-bold text-slate-800">Tag Location</h2>
                <p class="text-xs text-slate-500 mt-1">Add or edit intelligence labels for this coordinate.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block tracking-wider">Label Content</label>
                    <input type="text" id="markerLabelInput" placeholder="e.g. Suspect Sighting, Safehouse..." class="w-full border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block tracking-wider">Tag Color</label>
                    <div class="flex items-center gap-2">
                        <input type="color" id="markerColorInput" class="h-10 w-full border border-slate-200 rounded cursor-pointer p-1" value="#1e293b">
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button id="btnDeleteUserMarker" class="hidden flex-1 bg-rose-50 text-rose-600 hover:bg-rose-100 font-bold py-3 rounded-xl transition-all active:scale-95">Delete</button>
                    <button id="btnSaveUserMarker" class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95">Save Tag</button>
                </div>
                <button id="btnCancelUserMarker" class="w-full text-slate-400 text-xs font-bold py-2">Cancel</button>
            </div>
        </div>
    </div>

    <div id="columnMappingModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4 z-[10000]">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 animate-in zoom-in duration-200 flex flex-col max-h-[90vh]">
            <div class="mb-4 text-center">
                <h2 class="text-xl font-bold text-slate-800">Map Data Columns</h2>
                <p class="text-sm text-slate-500 mt-2">We couldn't automatically identify all columns. Please map your CSV headers to the required fields.</p>
            </div>
            <div class="space-y-4 overflow-y-auto flex-grow px-2">
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-4 text-xs text-blue-800">
                    <strong>Note:</strong> You must map either <strong>Latitude/Longitude</strong> OR <strong>Easting/Northing</strong>. Date is required.
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase block">Date Column <span class="text-red-500">*</span></label>
                        <select id="mapDate" class="w-full text-sm border border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase block">Time Column (Optional)</label>
                        <select id="mapTime" class="w-full text-sm border border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                    </div>
                </div>

                <div class="border-t border-slate-100 my-2 pt-2">
                    <p class="text-xs font-bold text-slate-500 mb-2 uppercase">Geospatial Coordinates</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase block">Latitude</label>
                            <select id="mapLat" class="w-full text-sm border border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase block">Longitude</label>
                            <select id="mapLng" class="w-full text-sm border border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                        </div>
                        <div class="col-span-2 text-center text-[10px] text-slate-300 font-bold uppercase tracking-widest">- OR -</div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase block">Easting</label>
                            <select id="mapEasting" class="w-full text-sm border border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase block">Northing</label>
                            <select id="mapNorthing" class="w-full text-sm border border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-100 flex gap-3">
                 <button id="btnCancelMapping" class="flex-1 text-slate-400 hover:text-slate-600 text-xs font-bold py-3">Cancel</button>
                 <button id="btnConfirmMapping" class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95">Next</button>
            </div>
        </div>
    </div>

    <div id="coLocationModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4 z-[10000]">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-in zoom-in duration-200">
            <div class="mb-4 text-center">
                <h2 class="text-lg font-bold text-slate-800">Co-location Analysis</h2>
                <p class="text-xs text-slate-500 mt-1">Select two distinct entities to compare.</p>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Entity A</label>
                    <select id="colocEntityA" class="w-full text-sm border border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Entity B</label>
                    <select id="colocEntityB" class="w-full text-sm border border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                </div>
                <div class="pt-2 flex gap-2">
                    <button id="btnCancelCoLocation" class="flex-1 text-slate-400 hover:text-slate-600 text-xs font-bold py-2">Cancel</button>
                    <button id="btnRunCoLocation" class="flex-[2] bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 rounded-xl shadow-lg transition-all active:scale-95">Analyze</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editEntityModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4 z-[10001]">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-in zoom-in duration-200">
            <h2 class="text-lg font-bold text-slate-800 mb-4">Edit Entity</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Entity Name</label>
                    <input type="text" id="editEntityName" class="w-full border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Color</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="editEntityColor" class="h-10 w-full border border-slate-200 rounded cursor-pointer p-1">
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button id="btnDeleteEntity" class="flex-1 bg-rose-50 text-rose-600 hover:bg-rose-100 font-bold py-2 rounded-xl transition-all">Delete</button>
                    <button id="btnSaveEntityChanges" class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-xl shadow-lg transition-all">Save</button>
                </div>
                <button id="btnCancelEditEntity" class="w-full text-slate-400 text-xs font-bold py-2">Cancel</button>
            </div>
        </div>
    </div>

    <div id="mapContextMenu" class="hidden absolute z-[9999] bg-white rounded-xl shadow-2xl border border-slate-100 w-48 overflow-hidden animate-in fade-in zoom-in-95 duration-100">
        <button id="ctxTagLocation" class="w-full text-left px-4 py-3 text-xs font-bold text-slate-700 hover:bg-blue-50 hover:text-blue-600 border-b border-slate-50 transition-colors flex items-center gap-2">
            <span>üìç</span> Tag Location
        </button>
        <button id="ctxLookupPostcode" class="w-full text-left px-4 py-3 text-xs font-bold text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition-colors flex items-center gap-2">
            <span>üìÆ</span> Lookup Postcode
        </button>
    </div>

    <div id="helpModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4 z-[10002]">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-in zoom-in duration-200">
            <div class="flex items-center gap-3 mb-4">
                <div class="p-2 bg-blue-50 text-blue-600 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h2 id="helpModalTitle" class="text-lg font-bold text-slate-800">Help</h2>
            </div>
            <p id="helpModalText" class="text-sm text-slate-600 leading-relaxed mb-6"></p>
            <button onclick="document.getElementById('helpModal').classList.add('hidden')" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2.5 rounded-xl transition-all">Close</button>
        </div>
    </div>

    <nav class="bg-white border-b px-6 py-4 flex flex-wrap justify-between items-center shadow-sm gap-4">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-slate-50 border border-slate-200 rounded-lg">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22C16.4183 22 20 18.4183 20 14C20 9 13 2 12 2C11 2 4 9 4 14C4 18.4183 7.58172 22 12 22Z" fill="#3B82F6"/>
                    <path d="M12 19.5C14.4853 19.5 16.5 17.4853 16.5 15C16.5 12.5 14.5 9 14.5 9C14.5 9 13.5 12 12 12C10.5 12 9.5 10 9.5 10C9.5 10 7.5 12.5 7.5 15C7.5 17.4853 9.51472 19.5 12 19.5Z" fill="#F97316"/>
                </svg>
            </div>
            <h1 class="text-xl font-extrabold tracking-tight text-slate-800 uppercase" style="font-family: 'Montserrat', sans-serif;">Burnmouth <span class="text-slate-400 font-semibold normal-case tracking-normal">- Geospatial tool kit</span></h1>
        </div>
        <div class="flex gap-3 items-center">
            <div class="relative">
                <input type="text" id="postcodeInput" placeholder="Postcode..." class="pl-3 pr-9 py-2.5 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-blue-500 outline-none w-32 focus:w-48 transition-all shadow-sm">
                <button id="btnSearchPostcode" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-blue-600 transition-colors p-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>
            </div>
            <label class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl transition-all shadow-md active:scale-95 text-sm font-semibold inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                Import CSV
                <input type="file" id="csvFile" accept=".csv" class="hidden">
            </label>
        </div>
    </nav>

    <main class="p-4 md:p-6 max-w-7xl mx-auto space-y-4 flex-grow">
        <div id="controls" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 space-y-6 hidden animate-in fade-in duration-500">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-6 space-y-5">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-1">
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Timeline</label>
                                <button onclick="openHelp('timeline')" class="text-slate-400 hover:text-blue-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                            </div>
                            <span id="range-display" class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">--</span>
                        </div>
                        <div id="date-slider" class="custom-slider mx-2"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 pt-2">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Start Time</label>
                            <input type="datetime-local" id="input-start" class="w-full text-sm border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">End Time</label>
                            <input type="datetime-local" id="input-end" class="w-full text-sm border border-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50">
                        </div>
                        <div class="flex items-end">
                            <button id="btnApplyFilter" class="w-full bg-orange-600 hover:bg-orange-700 text-white p-2.5 rounded-lg text-xs font-bold transition shadow-sm h-[42px]">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-6 flex flex-col gap-6 lg:border-l lg:pl-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div class="flex items-center gap-1 mb-2">
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider block">Visualisation Style</label>
                                <button onclick="openHelp('visualisation')" class="text-slate-400 hover:text-blue-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                            </div>
                            <div class="grid grid-cols-3 gap-1.5 p-1 bg-slate-100 rounded-xl">
                                <button id="viewMarkers" class="px-2 py-1.5 text-[10px] font-bold rounded-lg transition-all bg-white text-blue-600 shadow-sm border border-slate-200">Markers</button>
                                <button id="viewClusters" class="px-2 py-1.5 text-[10px] font-bold rounded-lg transition-all text-slate-600">Clusters</button>
                                <button id="viewHeatmap" class="px-2 py-1.5 text-[10px] font-bold rounded-lg transition-all text-slate-600">Heatmap</button>
                                <button id="viewPath" class="px-2 py-1.5 text-[10px] font-bold rounded-lg transition-all text-slate-600">Path</button>
                                <button id="view3D" class="col-span-2 px-2 py-1.5 text-[10px] font-bold rounded-lg transition-all text-slate-600 bg-slate-200/50 flex items-center justify-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                                    3D
                                </button>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-slate-100 grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-2">Active Entities</label>
                                    <div id="entityCheckboxList" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                                        <p class="text-[10px] text-slate-400 italic">No entities loaded</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-2">Tagged Locations</label>
                                    <div id="userMarkerList" class="flex flex-col gap-2 max-h-32 overflow-y-auto">
                                        <p class="text-[10px] text-slate-400 italic">No tags added</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider block">Animation Playback</label>
                            <div class="flex items-center gap-4">
                                <button id="btnPlay" class="flex-shrink-0 p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition shadow-md">
                                    <svg id="playIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                                    <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                                </button>
                                <div class="flex-grow space-y-1">
                                    <div class="flex justify-between items-center">
                                        <label class="text-[10px] font-bold text-slate-400 uppercase">Speed</label>
                                        <span id="speed-label" class="text-[10px] font-bold text-blue-600">Moderate</span>
                                    </div>
                                    <input type="range" id="playbackSpeedRange" min="0.0001" max="0.0019" step="0.0001" value="0.001" class="w-full h-1.5 bg-slate-100 rounded-lg appearance-none cursor-pointer">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap items-center justify-between gap-4 border-t border-slate-100 pt-5">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-1 mr-2">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Map Tools</span>
                        <button onclick="openHelp('maptools')" class="text-slate-400 hover:text-blue-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                    </div>
                    <button id="toggleLabels" class="px-4 py-2 text-xs font-bold text-slate-700 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition shadow-sm">
                        Show Labels: <span class="text-blue-600">Off</span>
                    </button>
                    <button id="toggleAutoSnap" class="px-4 py-2 text-xs font-bold text-slate-700 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition shadow-sm">
                        Auto-Snap: <span class="text-blue-600">Off</span>
                    </button>
                    <button id="btnStartDrawing" class="px-4 py-2 text-xs font-bold text-slate-700 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition shadow-sm inline-flex items-center gap-2">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Tag Location
                    </button>
                    <button id="btnResetAll" class="px-4 py-2 text-xs font-bold text-rose-600 bg-rose-50 border border-rose-100 rounded-xl hover:bg-rose-100 transition">
                        Clear Filters
                    </button>
                    <button id="btnFitSelected" class="px-4 py-2 text-xs font-bold text-indigo-600 bg-indigo-50 border border-indigo-100 rounded-xl hover:bg-indigo-100 transition hidden">
                        Fit Selected
                    </button>
                </div>

                <div class="flex items-center gap-3">
                    <button id="btnZoomToFit" class="px-5 py-2.5 text-xs font-bold text-white bg-blue-600 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">
                        Zoom to Fit
                    </button>
                    <div id="stats" class="text-xs font-black text-slate-700 bg-slate-100 border border-slate-200 px-4 py-2.5 rounded-xl">
                        Points: 0
                    </div>
                </div>
            </div>
        </div>

        <div id="empty-state" class="flex flex-col items-center justify-center min-h-[60vh] text-slate-400 bg-white rounded-3xl border-2 border-dashed border-slate-200">
            <div class="mb-8 relative group cursor-default">
                <div class="absolute -inset-1 bg-gradient-to-br from-blue-500 via-transparent to-orange-500 rounded-full blur opacity-60 group-hover:opacity-80 transition duration-500"></div>
                
                <div class="relative w-48 h-48 rounded-full p-1.5 bg-gradient-to-br from-blue-500 via-white to-orange-500 shadow-2xl">
                    <div class="w-full h-full rounded-full border-[3px] border-white overflow-hidden bg-slate-50 relative shadow-inner flex items-center justify-center p-8">
                        <svg class="w-full h-full drop-shadow-md" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C16.4183 22 20 18.4183 20 14C20 9 13 2 12 2C11 2 4 9 4 14C4 18.4183 7.58172 22 12 22Z" fill="#3B82F6"/>
                            <path d="M12 19.5C14.4853 19.5 16.5 17.4853 16.5 15C16.5 12.5 14.5 9 14.5 9C14.5 9 13.5 12 12 12C10.5 12 9.5 10 9.5 10C9.5 10 7.5 12.5 7.5 15C7.5 17.4853 9.51472 19.5 12 19.5Z" fill="#F97316"/>
                        </svg>
                    </div>
                </div>
            </div>
            <h3 class="text-slate-800 font-bold mb-2 text-lg font-['Montserrat']">Ready to Visualise</h3>
            <p class="text-sm max-w-xs text-center px-4 mb-6">Upload a CSV file to begin.</p>

            <details class="group mb-2 max-w-md w-full px-4 text-center cursor-pointer">
                <summary class="list-none text-xs font-bold text-blue-600 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-lg px-4 py-2 transition-all inline-flex items-center gap-2 select-none mx-auto">
                    <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    Upload Instructions & Requirements
                </summary>
                <div class="mt-3 text-left bg-slate-50 border border-slate-100 rounded-xl p-4 text-xs text-slate-600 space-y-2 shadow-sm animate-in slide-in-from-top-2 cursor-default">
                    <p class="font-bold text-slate-800 border-b border-slate-200 pb-1 mb-2">File Requirements</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li>File Format: <strong>.CSV</strong> (Comma Separated Values) only.</li>
                        <li><strong>Date Column:</strong> Required (e.g., DD/MM/YYYY).</li>
                        <li><strong>Time Column:</strong> Recommended for timeline analysis.</li>
                        <li><strong>Location Columns:</strong> Must contain either:
                            <ul class="list-circle pl-4 mt-1 text-slate-500">
                                <li>Latitude & Longitude</li>
                                <li>Easting & Northing (UK Grid)</li>
                            </ul>
                        </li>
                    </ul>
                    <p class="mt-2 italic text-[10px] text-slate-400">Note: If columns are not automatically detected, you will be prompted to map them manually.</p>
                </div>
            </details>

            <details class="group max-w-md w-full px-4 text-center cursor-pointer">
                <summary class="list-none text-xs font-bold text-emerald-600 hover:text-emerald-700 bg-emerald-50 hover:bg-emerald-100 rounded-lg px-4 py-2 transition-all inline-flex items-center gap-2 select-none mx-auto">
                    <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    <span>üîí Privacy & Data Security</span>
                </summary>
                <div class="mt-3 text-left bg-slate-50 border border-slate-100 rounded-xl p-4 text-[11px] text-slate-600 space-y-3 shadow-sm animate-in slide-in-from-top-2 cursor-default">
                    <p class="font-bold text-slate-800 border-b border-slate-200 pb-1">Burnmouth is a 100% Client-Side Application.</p>
                    <ul class="list-disc pl-4 space-y-2">
                        <li><strong>No Data Uploads:</strong> This tool operates entirely within your web browser. When you open a CSV file, it is processed locally on your machine using JavaScript. Your sensitive dataset (CDRs, location records) is never uploaded to a server, cloud storage, or external database.</li>
                        <li><strong>Volatile Memory:</strong> Your data exists only in your browser's temporary memory (RAM) while the tab is open. Refreshing the page or closing the window instantly and permanently wipes all loaded data from the application.</li>
                        <li><strong>Transparency on Network Traffic:</strong> The tool requires an internet connection solely for visualization assets. Your bulk data does not leave your device, but you will see network requests for:
                            <ul class="list-circle pl-4 mt-1 text-slate-500">
                                <li>Map Tiles: Fetching the visual map background (e.g., from OpenStreetMap or Carto).</li>
                                <li>Postcode Lookups: Sending individual coordinates to postcodes.io to retrieve location names (only occurs when you explicitly trigger a lookup or analysis).</li>
                            </ul>
                        </li>
                        <li><strong>Auditable Security:</strong> Because the application is a single static HTML file, the code is fully transparent. You can verify the security yourself by inspecting the source code to confirm there are no data export mechanisms.</li>
                    </ul>
                </div>
            </details>
        </div>

        <div id="map-container" class="relative hidden">
            <button id="btnToggleExpand" class="absolute top-4 left-14 z-[1000] bg-white border border-slate-200 p-2 rounded-lg shadow-md hover:bg-slate-50 transition-all text-slate-600 flex items-center gap-2 text-xs font-bold">
                <svg id="expandIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                <svg id="collapseIcon" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9L4 4m0 0h4m-4 0v4m11 1l5-5m0 0h-4m4 0v4m-11 11l-5-5m0 0v4m0-4h4m11 5l5-5m0 0v-4m0 4h-4"></path></svg>
                <span>Expand map</span>
            </button>
            <div id="map" class="shadow-xl border border-slate-200"></div>
            
            <div id="view-3d" class="shadow-xl border border-slate-200 hidden">
                <div id="nav-joystick" title="Click & Drag to Navigate"></div>
                <div id="nav-joystick-top" title="Click & Drag to Navigate"></div>
                
                <div id="time-axis-display" class="absolute right-6 top-8 bottom-24 flex flex-col justify-between text-right pointer-events-none z-10 hidden">
                    <div class="relative">
                        <span id="time-axis-end" class="text-[10px] font-bold text-green-400 bg-slate-900/50 px-1 rounded shadow-sm backdrop-blur-sm">--</span>
                        <div class="absolute right-[-14px] top-1/2 w-3 h-px bg-green-400"></div>
                    </div>
                    <div class="absolute right-[-12px] top-2 bottom-2 w-px bg-gradient-to-b from-green-400 via-blue-500 to-indigo-500 opacity-60"></div>
                    <div class="relative">
                        <span id="time-axis-start" class="text-[10px] font-bold text-indigo-400 bg-slate-900/50 px-1 rounded shadow-sm backdrop-blur-sm">--</span>
                        <div class="absolute right-[-14px] top-1/2 w-3 h-px bg-indigo-400"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="analysis-section" class="hidden space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex items-center gap-2 mb-4">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider block">Analytical Intelligence</label>
                    <button onclick="openHelp('analysis')" class="text-slate-400 hover:text-blue-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                </div>
                
                <div class="flex flex-col gap-6">
                    <button id="btnMostActive" class="w-full bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-xl text-sm font-bold uppercase tracking-widest transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Show top locations
                    </button>

                    <div>
                        <div class="flex items-center gap-1 mb-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block">Key location detector</label>
                            <button onclick="openHelp('keylocations')" class="text-slate-400 hover:text-blue-600"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-3">
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex flex-col justify-between gap-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase">Hubs (km)</span>
                                    <input type="number" id="transportRadius" value="5.0" step="0.5" class="w-12 text-xs border border-slate-200 rounded p-1 font-bold outline-none">
                                </div>
                                <button id="btnDetectTransport" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-[10px] font-bold uppercase transition">Airport/Seaport</button>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex flex-col justify-between gap-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase">Rail (km)</span>
                                    <input type="number" id="railRadius" value="2.5" step="0.1" class="w-12 text-xs border border-slate-200 rounded p-1 font-bold outline-none">
                                </div>
                                <button id="btnDetectRail" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-[10px] font-bold uppercase transition">Detect Rail</button>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex flex-col justify-between gap-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase">Prisons (km)</span>
                                    <input type="number" id="prisonRadius" value="1.0" step="0.1" class="w-12 text-xs border border-slate-200 rounded p-1 font-bold outline-none">
                                </div>
                                <button id="btnDetectPrisons" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-lg text-[10px] font-bold uppercase transition">Detect Prisons</button>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex flex-col justify-between gap-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase">Services (km)</span>
                                    <input type="number" id="serviceRadius" value="0.5" step="0.1" class="w-12 text-xs border border-slate-200 rounded p-1 font-bold outline-none">
                                </div>
                                <button id="btnDetectService" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg text-[10px] font-bold uppercase transition">Detect Services</button>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex flex-col justify-between gap-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase">Misc (km)</span>
                                    <input type="number" id="miscRadius" value="0.5" step="0.1" class="w-12 text-xs border border-slate-200 rounded p-1 font-bold outline-none">
                                </div>
                                <p class="text-[9px] text-slate-400 leading-tight">Hospitals, Stadiums, Shopping, Unis, Theme Parks</p>
                                <button id="btnDetectMisc" class="w-full bg-teal-600 hover:bg-teal-700 text-white py-2 rounded-lg text-[10px] font-bold uppercase transition">Detect Misc</button>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex flex-col justify-between gap-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase">Harbour (km)</span>
                                    <input type="number" id="harbourRadius" value="0.5" step="0.1" class="w-12 text-xs border border-slate-200 rounded p-1 font-bold outline-none">
                                </div>
                                <button id="btnDetectHarbours" class="w-full bg-cyan-700 hover:bg-cyan-800 text-white py-2 rounded-lg text-[10px] font-bold uppercase transition">Detect Maritime</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center gap-1 mb-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block">Advanced Pattern Analysis</label>
                            <button onclick="openHelp('advanced')" class="text-slate-400 hover:text-blue-600"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-xl flex flex-col gap-3">
                                <div class="flex items-center justify-between gap-4">
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] font-bold text-indigo-800 uppercase">Min Dist (km)</span>
                                        <input type="number" id="journeyMinDist" value="25" step="1" class="w-14 bg-white border border-indigo-200 rounded px-1 py-0.5 text-xs outline-none focus:ring-1 focus:ring-indigo-500">
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] font-bold text-indigo-800 uppercase">Certainty (%)</span>
                                        <input type="number" id="journeyCertainty" value="50" step="5" max="100" class="w-14 bg-white border border-indigo-200 rounded px-1 py-0.5 text-xs outline-none focus:ring-1 focus:ring-indigo-500">
                                    </div>
                                </div>
                                <p class="text-[10px] text-indigo-800 italic">Isolate sustained linear movements to identify journeys.</p>
                                <button id="btnDetectCarJourneys" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg text-xs font-bold uppercase tracking-wider transition shadow-sm mt-auto">
                                    Detect Journeys
                                </button>
                            </div>

                            <div class="bg-cyan-50 border border-cyan-100 p-4 rounded-xl flex flex-col gap-3">
                                <div class="flex items-center justify-between gap-4">
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] font-bold text-cyan-800 uppercase">Dist (km)</span>
                                        <input type="number" id="coLocationDist" value="1.0" step="0.1" class="w-14 bg-white border border-cyan-200 rounded px-1 py-0.5 text-xs outline-none focus:ring-1 focus:ring-cyan-500">
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] font-bold text-cyan-800 uppercase">Time (min)</span>
                                        <input type="number" id="coLocationTime" value="10" step="1" class="w-14 bg-white border border-cyan-200 rounded px-1 py-0.5 text-xs outline-none focus:ring-1 focus:ring-cyan-500">
                                    </div>
                                </div>
                                <p class="text-[10px] text-cyan-800 italic">Identify when different datasets intersect in time and space.</p>
                                <button id="btnDetectCoLocation" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-2.5 rounded-lg text-xs font-bold uppercase tracking-wider transition shadow-sm mt-auto">
                                    Detect Co-location
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analysis-results" class="hidden animate-in slide-in-from-bottom-4 duration-500">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="results-title" class="text-lg font-bold text-slate-800 tracking-tight">Detection Results</h2>
                        <span id="results-count" class="px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-[10px] font-black uppercase">0 Matches</span>
                    </div>
                    <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                    <div id="no-results" class="py-12 text-center text-slate-400 border border-dashed border-slate-200 rounded-xl">
                        <p class="text-sm italic">Perform a search to see analytical detections.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-auto py-6 px-6 text-center border-t border-slate-200 bg-white">
        <p class="text-[10px] text-slate-400 font-medium tracking-wide">Created by Phil Bennett 2025. All rights reserved.</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script src="data.js"></script>

    <script>
        

        let map, markerLayer, heatLayer, pathLayer, clusterLayer, userMarkerLayer;
        let allData = [];
        let userMarkers = []; // { id, lat, lng, label, color }
        let dateRange = { min: 0, max: 0 };
        let currentView = 'markers'; 
        let showLabels = false, autoSnap = false, isPlaying = false, playInterval = null;
        let isPlacementMode = false;
        let pendingCsvData = null; 
        let editingUserMarker = null;
        const LABEL_LIMIT = 500;
        let uniqueEntities = new Set();
        let entityColors = {}; 
        let activeEntityFilters = new Set();
        let activeColumnMap = null;
        let currentEditingEntity = null;
        
        // Context Menu State
        let contextMenuLatLng = null;
        // Help Text Data
        const helpData = {
            timeline: "Control the time range of your data. Drag the blue handles on the slider to narrow down the specific date and time window. You can also manually input start and end times below. The 'Apply' button updates the map.",
            visualisation: "Choose how to view your data: 'Markers' shows individual points, 'Clusters' groups them for clarity, 'Heatmap' shows density, 'Path' draws lines between points in time order, and '3D' opens the Space-Time Cube.",
            maptools: "Toggle labels on/off, enable 'Auto-Snap' to follow data during playback, or use 'Tag Location' to drop your own markers. 'Clear Filters' resets all views, selections, and time ranges.",
            analysis: "Use 'Show top locations' to automatically identify and list the top 12 most visited coordinates in your dataset, enriched with nearest postcode data.",
            keylocations: "Automatically scan your data for proximity to known sensitive locations such as Transport Hubs, Prisons, Hospitals, and Harbours. You can adjust the search radius (km) for each category.",
            advanced: "Detect complex patterns: 'Detect Journeys' identifies sustained movements over distance. 'Detect Co-location' finds instances where two entities (or an entity and a tag) were in the same place at the same time."
        };

        function openHelp(key) {
            const info = helpData[key];
            if (info) {
                document.getElementById('helpModalTitle').innerText = key === 'timeline' ? 'Timeline Controls' : 
                    key === 'visualisation' ? 'Visualisation Styles' :
                    key === 'maptools' ? 'Map Tools' :
                    key === 'analysis' ? 'Analytical Intelligence' :
                    key === 'keylocations' ? 'Key Location Detectors' : 'Advanced Analysis';
                document.getElementById('helpModalText').innerText = info;
                document.getElementById('helpModal').classList.remove('hidden');
            }
        }

        // 3D Variables
        let scene, camera, renderer, animationId;
        let is3DInitialized = false;
        let mapGroup = null; // Store map group globally to avoid rebuilding
        let worldScale = { x: 100, z: 100, latRange: 1, lngRange: 1, minLat: 0, minLng: 0, minTime: 0, timeRange: 1 };
        // Store world scaling factors
        
        // 3D Camera State (Global)
        let cameraOffset = new THREE.Vector3(0, 50, 0);
        let theta = Math.PI / 2; // Orient North (Looking from South along Z axis)
        let phi = Math.PI / 3;
        let radius = 180;

        // Selection Variables
        let pendingSelection = new Set();
        let activeSelectionFilter = null;
        let isSelecting = false;
        let selectionStartClient = { x: 0, y: 0 };
        // Screen relative
        const selectionBoxEl = document.createElement('div');
        selectionBoxEl.className = 'selection-box';
        function updateCameraPosition() {
            if (!camera) return;
            camera.position.x = cameraOffset.x + radius * Math.sin(phi) * Math.cos(theta);
            camera.position.y = cameraOffset.y + radius * Math.cos(phi);
            camera.position.z = cameraOffset.z + radius * Math.sin(phi) * Math.sin(theta);
            camera.lookAt(cameraOffset);
        }

        function getNextColor(index) {
            const palette = ["#2563eb", "#dc2626", "#16a34a", "#9333ea", "#ea580c", "#0891b2", "#4f46e5", "#be185d", "#ca8a04", "#15803d"];
            return palette[index % palette.length];
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function getAreaDescription(lat, lng) {
            let closest = null, minDist = Infinity;
            MAJOR_CITIES.forEach(city => {
                const d = getDistance(lat, lng, city.lat, city.lng);
                if (d < minDist) { minDist = d; closest = city; }
            });
            if (minDist < 1) return `Within ${closest.name} city centre`;
            if (minDist < 5) return `Approx ${minDist.toFixed(1)}km from ${closest.name}`;
            if (minDist < 15) return `Suburbs of ${closest.name}`;
            return `Region of ${closest.name}`;
        }

        function initMap() {
            if (map) return;
            const voyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap, &copy; CARTO' });
            const darkMatter = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap, &copy; CARTO' });
            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' });
            const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
            const baseMaps = { "Voyager (Light)": voyager, "Dark Matter": darkMatter, "OpenStreetMap": osm, "Satellite Imagery": satellite };
            map = L.map('map', { preferCanvas: true, layers: [voyager] }).setView([54.5, -3.0], 6);
            L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);
            L.control.scale({ imperial: true, metric: true, position: 'bottomright' }).addTo(map);

            markerLayer = L.layerGroup().addTo(map);
            pathLayer = L.layerGroup().addTo(map);
            userMarkerLayer = L.layerGroup().addTo(map);
            clusterLayer = L.markerClusterGroup({ 
                disableClusteringAtZoom: 17, 
                spiderfyOnMaxZoom: true,
                iconCreateFunction: function(cluster) {
                    const markers = cluster.getAllChildMarkers();
                    const entities = [...new Set(markers.map(m => m.options.entity).filter(Boolean))];
                    const count = markers.length;
                    
                    let bgStyle = '';
                    if (entities.length >= 2) {
                        const c1 = entityColors[entities[0]] || '#2563eb';
                        const c2 = entityColors[entities[1]] || '#ef4444';
                        bgStyle = `background: conic-gradient(${c1} 0% 50%, ${c2} 50% 100%)`;
                    } else if (entities.length === 1) {
                        bgStyle = `background: ${entityColors[entities[0]] || '#2563eb'}`;
                    } else {
                        bgStyle = `background: #2563eb`;
                    }

                    const html = `
                        <div style="width: 40px; height: 40px; border-radius: 50%; ${bgStyle}; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; color: #334155;">
                                ${count}
                            </div>
                        </div>
                    `;
                    return L.divIcon({ html: html, className: '', iconSize: L.point(40, 40) });
                }
            }).addTo(map);
            map.on('click', (e) => {
                document.getElementById('mapContextMenu').classList.add('hidden');
                if (isPlacementMode) {
                    togglePlacementMode(false);
                    openUserMarkerModal(null, e.latlng.lat, e.latlng.lng);
                }
            });
            
            // Context Menu Logic
            map.on('contextmenu', (e) => {
                const menu = document.getElementById('mapContextMenu');
                contextMenuLatLng = e.latlng;
                
                // Position menu at mouse cursor
                menu.style.left = e.originalEvent.pageX + 'px';
                menu.style.top = e.originalEvent.pageY + 'px';
                menu.classList.remove('hidden');
            });
            map.on('movestart', () => document.getElementById('mapContextMenu').classList.add('hidden'));
        }

        // Context Menu Action Handlers
        document.getElementById('ctxTagLocation').onclick = () => {
            document.getElementById('mapContextMenu').classList.add('hidden');
            if (contextMenuLatLng) {
                openUserMarkerModal(null, contextMenuLatLng.lat, contextMenuLatLng.lng);
            }
        };

        document.getElementById('ctxLookupPostcode').onclick = async () => {
            const menu = document.getElementById('mapContextMenu');
            menu.classList.add('hidden');
            if (!contextMenuLatLng) return;

            // Show loading popup
            const popup = L.popup()
                .setLatLng(contextMenuLatLng)
                .setContent('<div class="text-xs text-slate-500 font-bold">Scanning...</div>')
                .openOn(map);
            try {
                const response = await fetch(`https://api.postcodes.io/postcodes?lon=${contextMenuLatLng.lng}&lat=${contextMenuLatLng.lat}`);
                const data = await response.json();
                
                if (data.status === 200 && data.result && data.result.length > 0) {
                    const pc = data.result[0].postcode;
                    popup.setContent(`<div class="text-xs font-bold text-slate-800">üìç ${pc}</div>`);
                } else {
                    popup.setContent(`<div class="text-xs font-bold text-slate-400">No postcode found</div>`);
                }
            } catch (e) {
                popup.setContent(`<div class="text-xs font-bold text-rose-500">Error</div>`);
            }
        };
        
        // Close menu on global click
        document.addEventListener('click', (e) => {
            if (!document.getElementById('mapContextMenu').contains(e.target)) {
                document.getElementById('mapContextMenu').classList.add('hidden');
            }
        });
        function togglePlacementMode(force) {
            isPlacementMode = typeof force === 'boolean' ? force : !isPlacementMode;
            const mapEl = document.getElementById('map');
            const btn = document.getElementById('btnStartDrawing');
            if (isPlacementMode) {
                mapEl.classList.add('placement-cursor');
                btn.classList.add('ring-4', 'ring-blue-400', 'bg-slate-50');
                btn.innerText = "Click Map to Tag";
            } else {
                mapEl.classList.remove('placement-cursor');
                btn.classList.remove('ring-4', 'ring-blue-400', 'bg-slate-50');
                btn.innerHTML = `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> Tag Location`;
            }
        }

        function openUserMarkerModal(markerId, lat, lng) {
            const modal = document.getElementById('userMarkerModal');
            const input = document.getElementById('markerLabelInput');
            const colorInput = document.getElementById('markerColorInput');
            const delBtn = document.getElementById('btnDeleteUserMarker');
            const title = document.getElementById('markerModalTitle');
            
            modal.classList.remove('hidden');
            input.focus();
            if (markerId !== null) {
                const existing = userMarkers.find(m => m.id === markerId);
                editingUserMarker = { ...existing };
                input.value = existing.label;
                colorInput.value = existing.color || '#1e293b';
                delBtn.classList.remove('hidden');
                title.innerText = "Edit Tag";
            } else {
                editingUserMarker = { id: Date.now(), lat, lng, label: '', color: '#1e293b' };
                input.value = '';
                colorInput.value = '#1e293b';
                delBtn.classList.add('hidden');
                title.innerText = "Tag Location";
            }
        }

        function saveUserMarker() {
            const label = document.getElementById('markerLabelInput').value.trim();
            const color = document.getElementById('markerColorInput').value;
            if (!label) return;
            
            editingUserMarker.label = label;
            editingUserMarker.color = color;
            const index = userMarkers.findIndex(m => m.id === editingUserMarker.id);
            if (index !== -1) userMarkers[index] = editingUserMarker;
            else userMarkers.push(editingUserMarker);
            
            document.getElementById('userMarkerModal').classList.add('hidden');
            updateUserMarkersOnMap();
        }

        function deleteUserMarker() {
            if (!editingUserMarker) return;
            userMarkers = userMarkers.filter(m => m.id !== editingUserMarker.id);
            document.getElementById('userMarkerModal').classList.add('hidden');
            updateUserMarkersOnMap();
        }

        function updateUserMarkersOnMap() {
            userMarkerLayer.clearLayers();
            updateUserMarkerList();
            userMarkers.forEach(m => {
                const marker = L.circleMarker([m.lat, m.lng], {
                    radius: 8,
                    fillColor: m.color || '#1e293b',
                    color: '#ffffff',
                    weight: 2,
                    fillOpacity: 1
                }).bindTooltip(m.label, {
                    permanent: true,
                    direction: 'top',
                    className: 'user-label',
                    offset: [0, -10]
                }).addTo(userMarkerLayer);
                
                marker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    openUserMarkerModal(m.id);
                });
            });
        }

        function updateUserMarkerList() {
            const container = document.getElementById('userMarkerList');
            container.innerHTML = '';
            if (userMarkers.length === 0) {
                container.innerHTML = '<p class="text-[10px] text-slate-400 italic">No tags added</p>';
                return;
            }
            userMarkers.forEach(m => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-slate-50 border border-slate-200 px-3 py-2 rounded-lg hover:bg-white transition-colors group cursor-pointer";
                div.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${m.color || '#1e293b'}"></div>
                        <span class="text-[10px] font-bold text-slate-700 truncate">${m.label}</span>
                    </div>
                    <button class="text-slate-400 hover:text-blue-600 transition-colors opacity-0 group-hover:opacity-100">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </button>
                `;
                div.querySelector('button').onclick = (e) => {
                    e.stopPropagation();
                    openUserMarkerModal(m.id);
                };
                div.onclick = () => {
                    map.flyTo([m.lat, m.lng], 12);
                    openUserMarkerModal(m.id);
                };
                container.appendChild(div);
            });
        }

        function parseUKDate(dateStr, timeStr) {
            if (!dateStr) return NaN;
            dateStr = dateStr.toString().trim();
            timeStr = (timeStr || "00:00:00").toString().trim();
            const dateParts = dateStr.split(/[\/\-.]/);
            if (dateParts.length !== 3) return new Date(dateStr + ' ' + timeStr).getTime();
            const day = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1; 
            const year = dateParts[2].length === 2 ? 2000 + parseInt(dateParts[2], 10) : parseInt(dateParts[2], 10);
            const timeParts = timeStr.split(':');
            const hour = parseInt(timeParts[0], 10) || 0;
            const min = parseInt(timeParts[1], 10) || 0;
            const sec = parseInt(timeParts[2], 10) || 0;
            return new Date(year, month, day, hour, min, sec).getTime();
        }

        function formatToLocalISO(timestamp) {
            const date = new Date(timestamp);
            const pad = (n) => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function updateEntityCheckboxes() {
            const container = document.getElementById('entityCheckboxList');
            container.innerHTML = '';
            if (uniqueEntities.size === 0) {
                container.innerHTML = '<p class="text-[10px] text-slate-400 italic">No entities loaded</p>';
                return;
            }
            uniqueEntities.forEach(entity => {
                const wrapper = document.createElement('div');
                wrapper.className = "inline-flex items-center gap-0 bg-slate-50 border border-slate-200 rounded-lg overflow-hidden shadow-sm";
                
                const label = document.createElement('label');
                label.className = "flex items-center gap-2 px-3 py-1.5 cursor-pointer hover:bg-white transition-colors text-[10px] font-bold text-slate-700 border-r border-slate-100";
                const isChecked = activeEntityFilters.has(entity);
                const color = entityColors[entity] || "#2563eb";
                
                label.innerHTML = `
                    <input type="checkbox" value="${entity}" ${isChecked ? 'checked' : ''} class="w-3 h-3 rounded text-blue-600 focus:ring-blue-500">
                    <div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${color}"></div>
                    <span class="truncate max-w-[100px] select-none">${entity}</span>
                `;
                label.querySelector('input').onchange = (e) => {
                    if (e.target.checked) activeEntityFilters.add(entity);
                    else activeEntityFilters.delete(entity);
                    updateMap();
                };

                const editBtn = document.createElement('button');
                editBtn.className = "px-2 py-1.5 hover:bg-blue-50 text-slate-400 hover:text-blue-600 transition-colors";
                editBtn.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>`;
                editBtn.onclick = () => openEditEntityModal(entity);

                wrapper.appendChild(label);
                wrapper.appendChild(editBtn);
                container.appendChild(wrapper);
            });
        }

        function openEditEntityModal(name) {
            currentEditingEntity = name;
            document.getElementById('editEntityName').value = name;
            document.getElementById('editEntityColor').value = entityColors[name] || '#2563eb';
            document.getElementById('editEntityModal').classList.remove('hidden');
        }

        document.getElementById('btnSaveEntityChanges').onclick = () => {
            const newName = document.getElementById('editEntityName').value.trim();
            const newColor = document.getElementById('editEntityColor').value;
            
            if (!newName) return;
            if (newName !== currentEditingEntity && uniqueEntities.has(newName)) {
                alert("An entity with this name already exists.");
                return;
            }
